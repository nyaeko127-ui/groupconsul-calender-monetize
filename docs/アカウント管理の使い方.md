# アカウント管理の使い方（1からステップごと）

このガイドでは、**講師アカウントの一覧・追加・削除**と**運営権限の設定**を、初めての人でもできるようにステップごとに説明します。

---

## 全体の流れ（3ステップ）

1. **Supabase にテーブルを作る**（初回だけ）
2. **運営としてログインする**
3. **アカウント管理ページで講師・運営を追加・削除する**

---

## ステップ 0：準備（すでにできているか確認）

- このプロジェクトがローカルで動いていること（`npm run dev` で起動できる）
- Supabase のプロジェクトがあること（`.env.local` に `NEXT_PUBLIC_SUPABASE_URL` と `NEXT_PUBLIC_SUPABASE_ANON_KEY` が入っている）
- すでに「運営」としてログインできること（環境変数 `ADMIN_EMAILS` に自分のメールを入れている、または後でステップ1のあとに運営を追加する）

---

## ステップ 1：Supabase に「アカウント用のテーブル」を作る（初回だけ）

アカウント管理で使う **account_roles** というテーブルを、Supabase に1回だけ作成します。

### 1-1. Supabase のダッシュボードを開く

1. ブラウザで [https://supabase.com](https://supabase.com) にアクセス
2. ログインして、このプロジェクト用の **プロジェクト** を選択
3. 左メニューから **「SQL Editor」** をクリック

### 1-2. 次の SQL を実行する

1. SQL Editor で **「New query」** をクリック
2. 下の SQL を **そのままコピーして** 貼り付けます

```sql
-- 講師・運営アカウントを管理するテーブル
CREATE TABLE IF NOT EXISTS account_roles (
  email text PRIMARY KEY,
  role text NOT NULL CHECK (role IN ('instructor', 'admin')),
  created_at timestamptz NOT NULL DEFAULT now()
);

-- アクセス用のポリシー（API から読み書きできるようにする）
ALTER TABLE account_roles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow all for account_roles"
  ON account_roles FOR ALL
  USING (true)
  WITH CHECK (true);
```

3. 右下の **「Run」**（または Ctrl+Enter / Cmd+Enter）を押す
4. 画面に **「Success. No rows returned」** と出れば成功です

### 1-3. テーブルができたか確認する（任意）

1. 左メニューの **「Table Editor」** を開く
2. 一覧に **account_roles** が出ていれば OK です

---

## ステップ 2：運営としてログインする

アカウント管理ページは **運営だけ** が開けます。まず「運営」でログインする必要があります。

### 方法 A：すでに環境変数で運営になっている場合

- `.env.local` に `ADMIN_EMAILS=あなたのメール@example.com` のように設定してあれば、そのメールで Google ログインすると運営になります。
- その状態で **ステップ 3** の「運営カレンダー」→「アカウント管理」に進んでください。

### 方法 B：まだ運営がいない場合（初回だけ）

1. `.env.local` を開く
2. 次の行を追加または編集する（メールは自分の Google のメールに変える）

```
ADMIN_EMAILS=あなたのGoogleメール@gmail.com
```

3. 保存して、アプリを再起動する（`npm run dev` を一度止めて再度実行）
4. ブラウザで **トップページ** を開き、**Google でログイン** する
5. ログイン後、画面上部の **「運営カレンダー」** リンクが表示されていれば運営になっています

---

## ステップ 3：アカウント管理ページを開く

1. **運営** の状態で、画面上部の **「運営カレンダー」** をクリック
2. 運営カレンダーの画面で、右上あたりの **「アカウント管理」** ボタン（グレー）をクリック
3. **アカウント管理** のページが開きます

ここから「講師アカウント」と「運営権限のあるアカウント」を操作できます。

---

## ステップ 4：講師アカウントを追加する

講師として候補日時を出せるようにするメールアドレスを登録します。

1. **「講師アカウント」** のブロックまでスクロール
2. **メールアドレス** の欄に、講師にしてもらいたい人の **Google のメールアドレス** を入力  
   （例: `instructor@example.com`）
3. **権限** は **「講師として追加」** のままにする
4. **「追加」** ボタンを押す
5. 「講師を追加しました」と表示され、一覧にそのメールが追加されれば成功です

そのメールアドレスで Google ログインすれば、講師として講師カレンダーが使えます（ログイン時に自動で user_tokens に保存されるため、追加したメールでログインすれば利用可能になります）。

※ 現在の実装では「講師として追加」したメールが一覧に載るだけで、ログイン制限は行っていません。必要なら後からログイン可能なメールを制限する仕様に変更できます。

---

## ステップ 5：運営アカウントを追加する

別の人にも運営権限を持たせたいときに使います。

1. 同じ **「講師アカウント」** のブロック内のフォームを使う
2. **メールアドレス** に、運営にしたい人の **Google のメールアドレス** を入力
3. **権限** を **「運営として追加」** に変更
4. **「追加」** を押す
5. 「運営を追加しました」と出れば成功です

そのメールでログインすると、運営カレンダー・確定カレンダー・監査ログ・アカウント管理が使えるようになります。

---

## ステップ 6：講師・運営を削除する

### 講師の削除

1. **講師アカウント** の一覧で、削除したい行の **「削除」** をクリック
2. 確認ダイアログで **「OK」** を押す
3. 一覧からそのメールが消えれば完了です

### 運営の削除

1. **運営権限のあるアカウント** の一覧で、削除したい行の **「削除」** をクリック
2. **自分自身** の行には「削除」は出ません（自分自身の運営権限は削除できません）
3. 他の人のメールを削除すると、その人は運営ではなくなります

---

## よくあること

### Q. アカウント管理ボタンを押したらトップに飛ばされる

- **運営** としてログインしていない可能性があります。
- 環境変数 `ADMIN_EMAILS` に自分のメールが入っているか、またはアカウント管理で「運営として追加」されたメールでログインしているか確認してください。

### Q. 一覧が「読み込み中」のまま動かない

- ステップ 1 の **account_roles** テーブルが Supabase に作成されているか確認してください。
- ブラウザの開発者ツール（F12）の「Console」や「Network」でエラーが出ていないかも見てください。

### Q. 追加したのに「このメールアドレスは既に登録されています」と出る

- そのメールはすでに講師または運営として登録されています。一覧に表示されているか確認してください。

### Q. 環境変数 ADMIN_EMAILS とアカウント管理の違いは？

- **ADMIN_EMAILS**：`.env.local` で設定。ここに書いたメールは常に運営。画面の一覧には出ず、画面から削除できない。
- **アカウント管理で追加した運営**：DB（account_roles）に保存。一覧に表示され、画面から削除できる。

両方「運営」として扱われます。

---

## まとめチェックリスト

- [ ] ステップ 1：Supabase の SQL Editor で `account_roles` テーブルを作成した
- [ ] ステップ 2：運営としてログインできる（運営カレンダーが開ける）
- [ ] ステップ 3：運営カレンダー → アカウント管理 を開いた
- [ ] ステップ 4：講師のメールを「講師として追加」した（必要な場合）
- [ ] ステップ 5：運営のメールを「運営として追加」した（必要な場合）
- [ ] ステップ 6：不要なアカウントは「削除」で削除できることを確認した

ここまでできていれば、アカウント管理は問題なく使える状態です。
